<?php

// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * This is the settings file for the ten percent report, it handles global settings.
 *
 * @package   blocks-censusreport
 * @author    Tyler Bannister <tyler.bannister@remote-learner.net>
 * @copyright 2011 Remote Learner - http://www.remote-learner.net/
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */

$blockname  = 'block_censusreport';
$fields = array(
    'checkboxes' => array(
        'showcoursename'    => array('view', 'csv', 'pdf'),
        'showcoursecode'    => array('view', 'csv', 'pdf'),
        'showcourseid'      => array('view', 'csv', 'pdf'),
        'showstudentid'     => array('view', 'csv', 'pdf'),
        'showteachername'   => array('view', 'csv', 'pdf'),
        'showsignatureline' => array(    '', 'csv', 'pdf'),
        'showdateline'      => array(    '', 'csv', 'pdf')),
    'textfields' => array(
        'footermessage'     => array(    '',    '', 'pdf'))
);
$defaults   = array('checkboxes' => 0, 'textfields' => '');

foreach ($fields as $type => $row) {

    foreach ($row as $base => $cols) {
        $config   = $blockname .'_'. $base;

        if ($type == 'checkboxes') {
            if (isset($CFG->$config)) {
                $values = explode(',', $CFG->$config);
                foreach ($values as $value) {
                    $defaults[$config . $value] = 1;
                }
            }
        } else {
            $defaults[$config] = $CFG->$config;
        }

        foreach ($cols as $field) {

            if ($field == '') {
                continue;
            }

            $fieldname = $field;

            if (is_string($base) && ($base != '')) {
                $fieldname = $base . $field;
            }

            ${$fieldname} = $defaults[$type];

            // If a local value has been set.
            if (isset($this->config->$fieldname)) {
                ${$fieldname} = $this->config->$fieldname;

            // If a local value hasn't been set load global default.
            } else if (($type != 'checkboxes') && (array_key_exists($config, $defaults))) {
                ${$fieldname} = $defaults[$config];

            // If a local value hasn't been set load global default (checkboxes special case)
            } else if (array_key_exists($config . $field, $defaults)) {
                ${$fieldname} = $defaults[$config . $field];
            }
        }
    }
}

$override = $blockname .'_overrideinstances';
if (isset($CFG->$override) && $CFG->$override) {
    print('<h1 class="'. $blockname .'_override">'. get_string('overriden', $blockname) ."</h1>\n");
}
 ?>
<table align="center">
<tr>
  <th><?php print_string('setting', $blockname); ?></th>
  <th><?php print_string('online', $blockname); ?></th>
  <th><?php print_string('csv', $blockname); ?></th>
  <th class="center"><?php print_string('pdf', $blockname); ?></th>
</tr>
<?php
foreach ($fields['checkboxes'] as $name => $row) {

    $output    = '';
    foreach ($row as $field) {
        if ($field !== '') {
            $fieldname = $name . $field;
            $output .= '  <td class="'. $blockname ."_checkbox\">\n"
                     .'    <input type="hidden" name="'. $fieldname .'" value="0" />' ."\n"
                     .'    <input type="checkbox" name="'. $fieldname .'" alt="'
                     . get_string($field, $blockname) .'" value="1"';

            if (${$fieldname}) {
                $output .= ' checked="checked"';
            }
            $output .= " />\n";
        } else {
            $output .= "  <td>&nbsp;</td>\n";
        }
    }
    print("<tr>\n"
          .'  <td>'. get_string($name, $blockname) .":</td>\n"
          . $output . "  </td>\n");
    print("</tr>\n");
}
 ?>
<tr>
  <td colspan="4"><?php print get_string('footermessage', $blockname) ?>:</td>
</tr>
<tr>
  <td colspan="4">
    <textarea name="footermessagepdf" cols="60" rows="4"><?php echo $footermessagepdf; ?></textarea>
  </td>
</tr>
<tr>
  <td colspan="4" align="center"><input type="submit" value="<?php print_string('savechanges'); ?>" /></td>
</tr>
</table>